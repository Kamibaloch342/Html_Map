<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFLT | Ultimate QA Analytics Deck</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* === Advanced Styling with Glassmorphism & Theming === */
        :root {
            --font-sans: 'Inter', sans-serif;
            --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* --- Light Theme --- */
        body[data-theme='light'] {
            --bg-primary: #eef2f7;
            --bg-glass: rgba(255, 255, 255, 0.6);
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: rgba(0, 0, 0, 0.08);
            --brand-primary: #4f46e5;
            --brand-secondary: #10b981;
            --shadow-color: rgba(140, 152, 169, 0.1);
            --shadow-hover-color: rgba(140, 152, 169, 0.2);
            --map-tiles: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
        }

        /* --- Dark Theme --- */
        body[data-theme='dark'] {
            --bg-primary: #0b1120;
            --bg-glass: rgba(23, 33, 52, 0.7);
            --bg-secondary: #172134;
            --bg-tertiary: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --brand-primary: #818cf8;
            --brand-secondary: #34d399;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --shadow-hover-color: rgba(0, 0, 0, 0.3);
            --map-tiles: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        }

        /* --- Base Styles --- */
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-primary);
            background-image: radial-gradient(circle at 1px 1px, var(--border-color) 1px, transparent 0);
            background-size: 2rem 2rem;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- Layout & Cards --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: auto;
            gap: 1.5rem;
            padding: 1.5rem;
            opacity: 0; /* Initially hidden for load animation */
        }
        .card {
            background-color: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 1.25rem;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color);
            transition: all 0.3s var(--ease-out-quart);
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px var(--shadow-hover-color), 0 4px 6px -4px var(--shadow-hover-color);
            transform: translateY(-5px) scale(1.02);
            border-color: var(--brand-primary);
        }
        
        /* --- Skeleton Loaders --- */
        .skeleton {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-tertiary); z-index: 10;
            display: flex; align-items: center; justify-content: center;
        }
        .skeleton-content { width: 100%; height: 100%; position: relative; overflow: hidden; background-color: var(--bg-tertiary); }
        .skeleton-content::after {
            content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }
        
        /* --- Components & Controls --- */
        .chart-container, .table-container { flex-grow: 1; position: relative; min-height: 0; }
        canvas { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }
        .table-container { overflow-y: auto; }
        .table-container thead { background-color: var(--bg-tertiary); position: sticky; top: 0; z-index: 1; }
        .table-container tbody tr { transition: background-color 0.2s; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .table-container tbody tr:last-child { border-bottom: none; }
        .table-container tbody tr:hover { background-color: var(--bg-tertiary); }
        .filter-select { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); transition: all .2s; }
        .filter-select:hover { border-color: var(--brand-primary); }

        /* --- Custom Modal Styles (replaces Flowbite) --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.is-visible {
            display: flex; /* Show the modal */
            opacity: 1;
        }
        
        /* --- Grid Placements --- */
        .header { grid-column: 1 / -1; }
        .kpi { grid-column: span 3 / span 3; }
        .ai-analyst { grid-column: 1 / -1; grid-row: 2 / 3; }
        .trainer-leaderboard { grid-column: 1 / 7; grid-row: 3 / 6; }
        .observer-leaderboard { grid-column: 7 / -1; grid-row: 3 / 6; }
        .daily-activity { grid-column: 1 / 7; grid-row: 6 / 9; }
        .score-distribution { grid-column: 7 / -1; grid-row: 6 / 9; }
        .map-card { grid-column: 1 / 7; grid-row: 9 / 12; }
        .category-performance { grid-column: 7 / -1; grid-row: 9 / 12; }

    </style>
</head>
<body data-theme="light">
    <div class="dashboard-grid" id="dashboard-content">
        <header class="card header flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-2xl font-extrabold" style="color:var(--text-primary)">DFLT Ultimate QA Analytics</h1>
                    <p class="text-sm font-medium" style="color:var(--text-secondary)">Real-time Performance & Monitoring Deck</p>
                </div>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <select id="provinceFilter" class="filter-select"></select>
                <select id="trainerFilter" class="filter-select"></select>
                <select id="observerFilter" class="filter-select"></select>
                <button id="resetFilters" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md" style="background:var(--bg-tertiary)" title="Reset Filters">🔄</button>
                <button id="theme-toggle" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md" style="background:var(--bg-tertiary)" title="Toggle Theme">🌙</button>
            </div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </header>

        <div class="card kpi">
            <div class="flex items-center justify-between"><h3 class="font-semibold" style="color:var(--text-secondary)">Total Monitored</h3><span id="kpi1-trend" class="text-xs"></span></div>
            <p id="totalSessions" class="text-5xl font-black mt-1" style="color:var(--brand-primary)">0</p>
            <div class="h-10 mt-2"><canvas id="kpi1-chart"></canvas></div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        <div class="card kpi">
            <div class="flex items-center justify-between"><h3 class="font-semibold" style="color:var(--text-secondary)">Overall Avg Score</h3><span id="kpi2-trend" class="text-xs"></span></div>
            <p id="overallScore" class="text-5xl font-black mt-1" style="color:var(--brand-secondary)">0<span class="text-3xl">%</span></p>
            <div class="h-10 mt-2"><canvas id="kpi2-chart"></canvas></div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        <div class="card kpi">
            <h3 class="font-semibold" style="color:var(--text-secondary)">Top & Weakest Category</h3>
            <div class="mt-2 space-y-2">
                <div><p class="text-xs">Top</p><p id="topCategory" class="text-lg font-bold text-green-500">N/A</p></div>
                <div><p class="text-xs">Weakest</p><p id="bottomCategory" class="text-lg font-bold text-red-500">N/A</p></div>
            </div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        <div class="card kpi">
            <h3 class="font-semibold" style="color:var(--text-secondary)">Score Consistency</h3>
            <p id="scoreStdDev" class="text-5xl font-black text-orange-500 mt-1">0<span class="text-3xl">%</span></p>
            <p class="text-xs mt-1" style="color:var(--text-secondary)">Std. Deviation of all scores</p>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        
        <div class="card ai-analyst">
            <div class="flex items-center gap-3 mb-2">
                <svg class="w-6 h-6" style="color:var(--brand-primary)" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                <h3 class="text-md font-bold" style="color:var(--text-primary)">AI Analyst Insights</h3>
            </div>
            <p id="aiSummaryText" class="text-sm" style="color:var(--text-secondary)">Generating analysis...</p>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>

        <div class="card trainer-leaderboard">
            <h3 class="text-md font-bold flex-shrink-0" style="color:var(--text-primary)">Trainer Performance Leaderboard</h3>
            <div class="table-container mt-2"><table class="w-full text-left text-sm"><thead class="text-xs uppercase" style="color:var(--text-secondary)"><tr><th class="p-2">Trainer</th><th class="p-2">Sessions</th><th class="p-2">Avg. Score</th></tr></thead><tbody id="trainerTableBody"></tbody></table></div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        <div class="card observer-leaderboard">
            <h3 class="text-md font-bold flex-shrink-0" style="color:var(--text-primary)">QA Observer Activity</h3>
            <div class="table-container mt-2"><table class="w-full text-left text-sm"><thead class="text-xs uppercase" style="color:var(--text-secondary)"><tr><th class="p-2">Observer</th><th class="p-2">Sessions</th><th class="p-2">Avg Score Given</th></tr></thead><tbody id="observerTableBody"></tbody></table></div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        <div class="card daily-activity">
            <h3 class="text-md font-bold flex-shrink-0" style="color:var(--text-primary)">Daily Monitoring Trend</h3>
            <div class="chart-container"><canvas id="dailyActivityChart"></canvas></div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        <div class="card score-distribution">
            <h3 class="text-md font-bold flex-shrink-0" style="color:var(--text-primary)">Score Distribution & Category Breakdown</h3>
            <div class="flex h-full gap-4">
                <div class="w-1/2 chart-container"><canvas id="scoreHistogram"></canvas></div>
                <div class="w-1/2 chart-container"><canvas id="breakdownChart"></canvas></div>
            </div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        <div class="card map-card !p-0">
            <div id="map" class="h-full w-full rounded-xl"></div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
        <div class="card category-performance">
            <h3 class="text-md font-bold flex-shrink-0" style="color:var(--text-primary)">Category Performance Analysis</h3>
            <div class="chart-container"><canvas id="categoryPerformanceChart"></canvas></div>
            <div class="skeleton"><div class="skeleton-content"></div></div>
        </div>
    </div>
    
    <div id="detail-modal" class="modal">
        <div class="relative p-4 w-full max-w-2xl max-h-full">
            <div class="relative rounded-lg shadow" style="background:var(--bg-secondary)">
                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t" style="border-color:var(--border-color)">
                    <h3 id="modal-title" class="text-xl font-semibold" style="color:var(--text-primary)">Details</h3>
                    <button type="button" id="modal-close-button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>
                <div id="modal-body" class="p-4 md:p-5 space-y-4"></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const hardcodedCSVData = `observer_name,province_select,district_select,session_trainer1,session_trainer2,monitoring_date,B1,B2,B3,B4,B5,B6,B7,B8,B9,B10,B11,B12,B13,B14,B15,C1,C2,C3.,C4,C5,C6,C7,C8,C9,C10,D1,D2,D3,D4,D5,D6,D7,D8,E1,E2,E3,F1,KEY
QAMujeeb,Punjab,Sargodha,maria_rehmann,nasreen_fatima,2025-09-10,4,4,1,4,4,4,1,2,3,4,2,2,1,3,5,1,1,5,1,1,1,1,5,2,5,4,2,5,5,1,3,1,5,1,1,3,1,uuid:a266d6d0
QAAli,Sindh,Karachi,ahmed_khan,fatima_ali,2025-09-10,5,5,4,5,5,5,4,5,5,4,5,4,5,5,4,5,5,5,5,5,4,5,4,5,5,5,4,5,5,4,5,5,5,5,5,5,5,uuid:b123c456
QAFatima,Punjab,Lahore,zoya_iqbal,bilal_ahmed,2025-09-09,4,3,4,4,5,3,4,4,3,4,4,3,4,4,4,4,4,4,3,5,4,4,4,5,4,4,3,4,5,4,4,5,4,5,5,4,4,uuid:c789d012
QAMujeeb,KPK,Peshawar,sana_ullah,hina_khan,2025-09-09,3,4,3,3,4,2,3,4,3,3,4,3,3,4,3,4,3,3,4,4,3,4,3,4,4,3,2,4,4,3,3,4,4,4,4,3,3,uuid:d345e678
QASara,Sindh,Hyderabad,imran_syed,aisha_begum,2025-09-08,5,4,5,5,4,5,5,5,4,5,5,4,5,5,5,5,5,5,4,5,5,5,5,5,5,5,5,5,5,5,4,5,5,5,5,5,5,uuid:f901g234
QAAli,Punjab,Sargodha,maria_rehmann,nasreen_fatima,2025-09-08,4,4,2,3,4,3,4,3,3,4,3,3,2,4,4,3,2,4,3,4,4,3,4,3,4,4,3,4,4,2,3,4,3,4,4,4,3,uuid:h567i890
QAFatima,Balochistan,Quetta,farhan_malik,samina_bibi,2025-09-07,2,3,2,3,3,1,2,3,2,3,3,2,2,3,2,3,2,2,3,3,2,3,2,3,3,2,1,3,3,2,2,3,3,3,3,2,2,uuid:j123k456
QAMujeeb,Punjab,Lahore,zoya_iqbal,bilal_ahmed,2025-09-10,5,5,5,4,5,4,5,5,4,5,5,4,5,5,4,5,4,5,5,5,4,5,4,5,5,5,4,5,5,4,5,5,4,5,5,4,5,uuid:l789m012
`;

    const App = {
        config: {
            ratingCategories: {
                'B': 'Quality of Training',
                'C': 'Knowledge & Communication',
                'D': 'Training Delivery',
                'E': 'Logistics & Observation',
                'F': 'Participant Engagement'
            },
            ratingColumnsRegex: /^[BCDEF]\d+$/,
            initialMapCenter: [30.3753, 69.3451],
            initialMapZoom: 5.5,
        },
        // MODIFIED: State now holds a reference to the modal DOM element
        state: { qaData: [], filteredData: [], charts: {}, map: null, markers: null, modalElement: null, filters: { province: 'All', trainerPair: 'All', observer: 'All' }, theme: 'light' },

        async init() {
            this.ui.showLoading();
            this.charts.registerPlugins();

            try {
                this.state.qaData = this.data.process(hardcodedCSVData);
                
                // MODIFIED: Instead of initializing a Flowbite modal, we just get the element
                this.state.modalElement = document.getElementById('detail-modal');
                
                this.map.init();
                this.charts.init();
                
                this.ui.populateFilters(this.state.qaData);
                this.applyFiltersAndRender();

                this.ui.hideLoading();
                this.ui.animateDashboardEntry();
                this.events.setup();
            } catch (error) {
                console.error("Dashboard initialization failed:", error);
                document.body.innerHTML = `<div class="p-8 text-center bg-red-100 text-red-800 rounded-lg m-8"><strong>Fatal Error:</strong> Could not load and process dashboard data. Please check the data source and console for details. <br><br> ${error.message}</div>`;
            }
        },

        data: {
            parseDate(dateString) {
                if (!dateString) return null;
                const parsed = new Date(dateString);
                return isNaN(parsed.getTime()) ? null : parsed;
            },
            process(csvText) {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                return lines.slice(1).map(line => {
                    try {
                        const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        if (values.length < headers.length) return null;
                        const row = headers.reduce((obj, h, i) => ({ ...obj, [h]: (values[i] || '').trim().replace(/"/g, '') }), {});
                        let scores = [];
                        let categoryScores = {};
                        Object.keys(App.config.ratingCategories).forEach(key => categoryScores[key] = []);
                        Object.keys(row).forEach(key => {
                            if (App.config.ratingColumnsRegex.test(key)) {
                                const value = parseInt(row[key], 10);
                                if (!isNaN(value)) {
                                    scores.push(value);
                                    const categoryKey = key.charAt(0);
                                    if(categoryScores[categoryKey]) {
                                        categoryScores[categoryKey].push(value);
                                    }
                                }
                            }
                        });
                        const validScores = scores.filter(s => s > 0);
                        const score = validScores.length > 0 ? (validScores.reduce((a, b) => a + b, 0) / (validScores.length * 5)) * 100 : 0;
                        const monitoringDate = this.parseDate(row.monitoring_date);
                        if (!monitoringDate) return null;
                        const trainerPair = [row.session_trainer1, row.session_trainer2].filter(Boolean).sort().join(' & ');
                        if (!trainerPair) return null;
                        const location = App.helpers.getLocationForDistrict(row.district_select);
                        return {
                            ...row,
                            session_province: row.province_select,
                            session_district: row.district_select,
                            observer_name: row.observer_name,
                            training_location: location,
                            score,
                            categoryAverages: Object.fromEntries(Object.entries(categoryScores).map(([k, s]) => {
                                const validCatScores = s.filter(v => v > 0);
                                return [k, validCatScores.length ? (validCatScores.reduce((a,b)=>a+b,0) / (validCatScores.length * 5)) * 100 : 0];
                            })),
                            trainerPair,
                            monitoringDate,
                        };
                    } catch (e) {
                        console.warn('Skipping malformed row:', line, e);
                        return null;
                    }
                }).filter(Boolean);
            }
        },

        applyFiltersAndRender() {
            const { qaData, filters } = this.state;
            this.state.filteredData = qaData.filter(d =>
                (filters.province === 'All' || d.session_province === filters.province) &&
                (filters.trainerPair === 'All' || d.trainerPair === filters.trainerPair) &&
                (filters.observer === 'All' || d.observer_name === filters.observer)
            );
            this.ui.updateKPIs(this.state.filteredData);
            this.ui.renderTables(this.state.filteredData);
            this.ui.updateAIAnalyst(this.state.filteredData);
            this.charts.update(this.state.filteredData);
            this.map.update(this.state.filteredData);
        },
        
        ui: {
            showLoading() { document.querySelectorAll('.skeleton').forEach(el => el.style.display = 'flex'); },
            hideLoading() { document.querySelectorAll('.skeleton').forEach(el => el.style.display = 'none'); },
            animateDashboardEntry() {
                anime({ targets: '.dashboard-grid', opacity: [0, 1], duration: 500, easing: 'easeInOutQuad' });
                anime({ targets: '.card', translateY: [30, 0], opacity: [0, 1], delay: anime.stagger(60, {start: 200}), duration: 700, easing: 'easeOutQuart' });
            },
            updateKPIs(data) {
                const total = data.length;
                const avgScore = total ? data.reduce((s, d) => s + d.score, 0) / total : 0;
                const now = new Date();
                const last7DaysData = data.filter(d => (now - d.monitoringDate) / (1000*3600*24) <= 7);
                const prev7DaysData = data.filter(d => {
                    const daysAgo = (now - d.monitoringDate) / (1000*3600*24);
                    return daysAgo > 7 && daysAgo <= 14;
                });
                const last7Avg = last7DaysData.length ? last7DaysData.reduce((s,d)=>s+d.score,0) / last7DaysData.length : 0;
                const prev7Avg = prev7DaysData.length ? prev7DaysData.reduce((s,d)=>s+d.score,0) / prev7DaysData.length : 0;
                const scoreTrend = last7DaysData.length && prev7DaysData.length ? last7Avg - prev7Avg : 0;
                const sessionsTrend = last7DaysData.length - prev7DaysData.length;
                this.renderTrend('kpi1-trend', sessionsTrend, '');
                this.renderTrend('kpi2-trend', scoreTrend, '%');
                App.helpers.animateValue('totalSessions', total, 0);
                App.helpers.animateValue('overallScore', avgScore, 0, '%');
                const scores = data.map(d => d.score);
                const stdDev = scores.length > 1 ? App.helpers.calculateStdDev(scores) : 0;
                App.helpers.animateValue('scoreStdDev', stdDev, 1, '%');
                const categoryAvgs = Object.keys(App.config.ratingCategories).map(catKey => ({
                    name: App.config.ratingCategories[catKey],
                    score: total ? data.reduce((s,d) => s + (d.categoryAverages[catKey] || 0), 0) / total : 0
                })).sort((a,b) => b.score - a.score);
                document.getElementById('topCategory').textContent = categoryAvgs.length > 0 ? categoryAvgs[0].name : 'N/A';
                document.getElementById('bottomCategory').textContent = categoryAvgs.length > 0 ? categoryAvgs[categoryAvgs.length-1].name : 'N/A';
            },
            renderTrend(elementId, value, suffix) {
                const el = document.getElementById(elementId);
                el.textContent = `${value >= 0 ? '▲' : '▼'} ${Math.abs(value).toFixed(1)}${suffix}`;
                el.className = `text-xs font-bold ${value >= 0 ? 'text-green-500' : 'text-red-500'}`;
            },
            renderTables(data) {
                const createRow = (d, type) => {
                    const row = document.createElement('tr');
                    // FIX: Ensure d.KEY is used for the detail modal to link to the session.
                    row.onclick = () => App.ui.showModal(d.key, type);
                    row.innerHTML = `<td class="p-2 font-bold">${d.key}</td> <td class="p-2">${d.count}</td><td class="p-2"><div class="w-full bg-gray-200 rounded-full h-2" style="background:var(--bg-tertiary)"><div class="h-2 rounded-full" style="width:${d.avgScore}%; background-color:${App.helpers.getScoreColor(d.avgScore)};"></div></div><span class="text-xs font-semibold" style="color:${App.helpers.getScoreColor(d.avgScore)}">${d.avgScore.toFixed(1)}%</span></td>`;
                    return row;
                };
                const trainerStats = App.helpers.aggregateBy(data, 'trainerPair').sort((a,b) => b.avgScore - a.avgScore);
                const observerStats = App.helpers.aggregateBy(data, 'observer_name').sort((a,b) => b.count - a.count);
                const trainerBody = document.getElementById('trainerTableBody'); trainerBody.innerHTML = '';
                trainerStats.forEach(d => trainerBody.appendChild(createRow(d, 'trainerPair')));
                const observerBody = document.getElementById('observerTableBody'); observerBody.innerHTML = '';
                observerStats.forEach(d => observerBody.appendChild(createRow(d, 'observer_name')));
            },
            populateFilters(data) {
                const createOptions = (sel, options, name) => { 
                    sel.innerHTML = `<option value="All">All ${name}</option>`; 
                    [...new Set(options)].sort().forEach(o => sel.add(new Option(o, o))); 
                };
                createOptions(document.getElementById('provinceFilter'), data.map(d => d.session_province), 'Provinces');
                createOptions(document.getElementById('trainerFilter'), data.map(d => d.trainerPair), 'Trainers');
                createOptions(document.getElementById('observerFilter'), data.map(d => d.observer_name).filter(Boolean), 'Observers');
            },
            toggleTheme() {
                App.state.theme = App.state.theme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', App.state.theme);
                document.getElementById('theme-toggle').textContent = App.state.theme === 'light' ? '🌙' : '☀️';
                App.map.update(App.state.filteredData, true); 
                App.charts.update(App.state.filteredData);
            },
            showModal(key, type) {
                const modalData = App.state.qaData.filter(d => d[type] === key).sort((a,b) => b.monitoringDate - a.monitoringDate);
                if (!modalData.length) return;
                
                const title = type === 'trainerPair' ? `Trainer Report: ${key}` : `Observer Report: ${key}`;
                document.getElementById('modal-title').textContent = title;

                const avgScore = modalData.reduce((acc, d) => acc + d.score, 0) / modalData.length;
                
                const bodyHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div class="p-4 rounded-lg" style="background:var(--bg-tertiary)"><h4 class="font-semibold mb-2">Performance Trend</h4><div class="h-40"><canvas id="modal-chart"></canvas></div></div><div class="p-4 rounded-lg" style="background:var(--bg-tertiary)"><h4 class="font-semibold mb-2">Key Stats</h4><div class="space-y-2 text-sm"><p><strong>Total Sessions:</strong> ${modalData.length}</p><p><strong>Average Score:</strong> <span style="color:${App.helpers.getScoreColor(avgScore)}">${avgScore.toFixed(1)}%</span></p><p><strong>Provinces:</strong> ${[...new Set(modalData.map(d => d.session_province))].join(', ')}</p><p><strong>Last Activity:</strong> ${App.helpers.formatDate(modalData[0].monitoringDate)}</p></div></div></div><h4 class="font-semibold mb-2">Recent Sessions</h4><div class="relative overflow-x-auto max-h-60"><table class="w-full text-sm text-left"><tbody>${modalData.slice(0, 10).map(d => `<tr class="border-b" style="border-color:var(--border-color)"><td class="px-4 py-2">${App.helpers.formatDate(d.monitoringDate)}</td><td class="px-4 py-2">${d.session_district}</td><td class="px-4 py-2">${type === 'trainerPair' ? d.observer_name : d.trainerPair}</td><td class="px-4 py-2 font-bold" style="color:${App.helpers.getScoreColor(d.score)}">${d.score.toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
                
                document.getElementById('modal-body').innerHTML = bodyHtml;
                // MODIFIED: Show the modal using a simple CSS class
                App.state.modalElement.classList.add('is-visible');

                const ctx = document.getElementById('modal-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: { labels: modalData.map(d => d.monitoringDate).reverse(), datasets: [{ data: modalData.map(d => d.score).reverse(), borderColor: getComputedStyle(document.body).getPropertyValue('--brand-primary'), tension: 0.3, fill: false }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}}, scales: { x: { type: 'time', time: {unit: 'day'}}, y: {beginAtZero: true, max: 100} }}
                });
            },
            updateAIAnalyst(data) {
                if (data.length === 0) {
                    document.getElementById('aiSummaryText').textContent = "No data available for the current filter selection."; return;
                }
                const avgScore = data.reduce((s, d) => s + d.score, 0) / data.length;
                const trainerStats = App.helpers.aggregateBy(data, 'trainerPair').sort((a,b) => b.avgScore - a.avgScore);
                const topTrainer = trainerStats[0];
                const bottomTrainer = trainerStats[trainerStats.length - 1];
                const categoryAvgs = Object.keys(App.config.ratingCategories).map(catKey => ({ name: App.config.ratingCategories[catKey], score: data.reduce((s,d) => s + (d.categoryAverages[catKey] || 0), 0) / data.length })).sort((a,b) => b.score - a.score);
                let insights = `With **${data.length}** sessions analyzed, the overall average score is **${avgScore.toFixed(1)}%**. `;
                if (topTrainer) insights += `The top-performing trainer is **${topTrainer.key}** with an average of **${topTrainer.avgScore.toFixed(1)}%**. `;
                if (bottomTrainer && bottomTrainer.key !== topTrainer.key) insights += `Conversely, **${bottomTrainer.key}** shows potential for improvement, averaging **${bottomTrainer.avgScore.toFixed(1)}%**. `;
                insights += `The strongest category is **${categoryAvgs[0].name}** (${categoryAvgs[0].score.toFixed(1)}%), while **${categoryAvgs[categoryAvgs.length-1].name}** (${categoryAvgs[categoryAvgs.length-1].score.toFixed(1)}%) is the primary area for development.`;
                document.getElementById('aiSummaryText').innerHTML = insights.replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--text-primary)">$1</strong>');
            }
        },

        charts: {
            registerPlugins() {
                const noDataPlugin = {
                    id: 'noData',
                    afterDraw(chart) {
                        if (chart.data.datasets.every(d => d.data.length === 0)) {
                            const { ctx, chartArea: { left, top, right, bottom } } = chart;
                            ctx.save();
                            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                            ctx.font = `bold 16px ${getComputedStyle(document.body).getPropertyValue('--font-sans')}`;
                            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
                            ctx.fillText('No data to display for the selected filters', (left + right) / 2, (top + bottom) / 2);
                            ctx.restore();
                        }
                    }
                };
                Chart.register(noDataPlugin);
            },
            init() {
                const commonOptions = { responsive: true, maintainAspectRatio: false, animation: { duration: 800, easing: 'easeOutQuart' }, plugins: { legend: { display: false } }, interaction: { intersect: false, mode: 'index' } };
                const sparklineOptions = { ...commonOptions, scales: { x: { display: false }, y: { display: false } }, elements: { point: { radius: 0 } }, plugins: { legend: { display: false }, tooltip: { enabled: false } } };
                App.state.charts.kpi1 = new Chart('kpi1-chart', { type: 'line', options: sparklineOptions });
                App.state.charts.kpi2 = new Chart('kpi2-chart', { type: 'line', options: sparklineOptions });
                App.state.charts.daily = new Chart('dailyActivityChart', { type: 'line', options: { ...commonOptions, scales: { x: { type: 'time', time: { unit: 'day' }, grid: { display: false } }, y: { beginAtZero: true } } } });
                App.state.charts.histogram = new Chart('scoreHistogram', { type: 'bar', data: { labels: ['0-10', '11-20', '21-30', '31-40', '41-50', '51-60', '61-70', '71-80', '81-90', '91-100'] }, options: { ...commonOptions, scales: { x: { grid: { display: false } }, y: { beginAtZero: true } } } });
                App.state.charts.radar = new Chart('breakdownChart', { type: 'radar', data: { labels: Object.values(App.config.ratingCategories) }, options: { ...commonOptions, scales: { r: { beginAtZero: true, max: 100, pointLabels: { font: { size: 10 } }, ticks: { backdropColor: 'transparent', stepSize: 25 } } } } });
                App.state.charts.categoryPerformance = new Chart('categoryPerformanceChart', { type: 'bar', options: { ...commonOptions, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100 }, y: { grid: { display: false } } } } });
            },
            update(data) {
                const { daily, histogram, radar, categoryPerformance, kpi1, kpi2 } = App.state.charts;
                const brandPrimary = getComputedStyle(document.body).getPropertyValue('--brand-primary');
                const brandSecondary = getComputedStyle(document.body).getPropertyValue('--brand-secondary');
                Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--text-secondary');
                const trendData = App.helpers.aggregateByDate(data, 'monitoringDate', 14);
                kpi1.data = { labels: trendData.labels, datasets: [{ data: trendData.data, borderColor: brandPrimary, fill: true, backgroundColor: App.helpers.hexToRgba(brandPrimary, 0.1), tension: 0.4 }] }; kpi1.update();
                const scoreTrendData = App.helpers.aggregateScoresByDate(data, 'monitoringDate', 14);
                kpi2.data = { labels: scoreTrendData.labels, datasets: [{ data: scoreTrendData.data, borderColor: brandSecondary, fill: true, backgroundColor: App.helpers.hexToRgba(brandSecondary, 0.1), tension: 0.4 }] }; kpi2.update();
                const activity = App.helpers.aggregateByDate(data, 'monitoringDate');
                daily.data = { labels: activity.labels, datasets: [{ data: activity.data, borderColor: brandPrimary, backgroundColor: App.helpers.hexToRgba(brandPrimary, 0.2), fill: true, tension: 0.4 }] }; daily.update();
                const scoreBins = Array(10).fill(0); data.forEach(d => { scoreBins[Math.min(9, Math.floor(d.score / 10))]++; });
                histogram.data.datasets[0] = { data: scoreBins, backgroundColor: scoreBins.map((_, i) => App.helpers.hexToRgba(brandSecondary, (i + 1) / 10)) }; histogram.update();
                const categoryData = Object.keys(App.config.ratingCategories).map(catKey => data.length ? data.reduce((s,d) => s + (d.categoryAverages[catKey] || 0), 0) / data.length : 0 );
                radar.data.datasets[0] = { data: categoryData, backgroundColor: App.helpers.hexToRgba(brandPrimary, 0.2), borderColor: brandPrimary }; radar.update();
                const categoryAvgs = Object.keys(App.config.ratingCategories).map(catKey => ({ name: App.config.ratingCategories[catKey], score: data.length ? data.reduce((s,d) => s + (d.categoryAverages[catKey] || 0), 0) / data.length : 0 })).sort((a,b) => a.score - b.score);
                categoryPerformance.data = { labels: categoryAvgs.map(c => c.name), datasets: [{ data: categoryAvgs.map(c => c.score), backgroundColor: categoryAvgs.map(c => App.helpers.getScoreColor(c.score)) }] };
                categoryPerformance.update();
            }
        },

        map: {
            init() {
                App.state.map = L.map('map').setView(App.config.initialMapCenter, App.config.initialMapZoom);
                App.state.markers = L.markerClusterGroup(); App.state.map.addLayer(App.state.markers); this.updateTileLayer();
            },
            updateTileLayer() {
                if (App.state.tileLayer) App.state.tileLayer.remove();
                const mapUrl = getComputedStyle(document.body).getPropertyValue('--map-tiles').trim().replace(/'/g, '');
                App.state.tileLayer = L.tileLayer(mapUrl, { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> & <a href="https://carto.com/attributions">CARTO</a>' }).addTo(App.state.map);
            },
            update(data, forceRedraw = false) {
                if(forceRedraw) this.updateTileLayer();
                App.state.markers.clearLayers();
                data.forEach(d => {
                    if (d.training_location) {
                        const [lat, lon] = d.training_location.split(' ').map(Number);
                        if(lat && lon) {
                            const color = App.helpers.getScoreColor(d.score);
                            const icon = L.divIcon({ html: `<svg viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.4));"><path fill="${color}" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/><circle cx="12" cy="9.5" r="2.5" fill="white" opacity="0.5"/></svg>`, className: '', iconSize: [24, 24], iconAnchor: [12, 24] });
                            const marker = L.marker([lat, lon], { icon });
                            marker.bindPopup(`<b>${d.trainerPair}</b><br>District: ${d.session_district}<br>Score: ${d.score.toFixed(1)}%`);
                            App.state.markers.addLayer(marker);
                        }
                    }
                });
                if(App.state.markers.getLayers().length > 0) App.state.map.fitBounds(App.state.markers.getBounds().pad(0.2));
            }
        },

        events: {
            setup() {
                ['provinceFilter', 'trainerFilter', 'observerFilter'].forEach(id => document.getElementById(id).addEventListener('change', e => {
                    const key = id.replace('Filter',''); App.state.filters[key === 'trainer' ? 'trainerPair' : key] = e.target.value; App.applyFiltersAndRender();
                }));
                document.getElementById('resetFilters').addEventListener('click', () => {
                    App.state.filters = { province: 'All', trainerPair: 'All', observer: 'All' };
                    document.querySelectorAll('select').forEach(s => s.value = 'All'); App.applyFiltersAndRender();
                });
                document.getElementById('theme-toggle').addEventListener('click', () => App.ui.toggleTheme());

                // MODIFIED: Event listeners to close the custom modal
                document.getElementById('modal-close-button').addEventListener('click', () => {
                    App.state.modalElement.classList.remove('is-visible');
                });
                App.state.modalElement.addEventListener('click', (e) => {
                    if (e.target === App.state.modalElement) { // Closes if you click on the dark background
                        App.state.modalElement.classList.remove('is-visible');
                    }
                });
            }
        },
        
        helpers: {
            locationLookup: { 'Sargodha': '32.0836 72.6711', 'Karachi': '24.8607 67.0011', 'Lahore': '31.5204 74.3587', 'Peshawar': '34.0151 71.5249', 'Hyderabad': '25.3960 68.3578', 'Quetta': '30.1798 66.9750' },
            getLocationForDistrict(district) { return this.locationLookup[district] || `${30.0 + Math.random()*5} ${68.0 + Math.random()*5}`; },
            getScoreColor: s => s >= 85 ? '#10b981' : s >= 70 ? '#f59e0b' : '#ef4444',
            hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            },
            animateValue(id, end, decimals = 0, suffix = '') {
                const el = document.getElementById(id); if(!el) return;
                const obj = { value: parseFloat(el.textContent.replace(/[^0-9.-]+/g,'')) || 0 };
                anime({
                    targets: obj, value: end, round: 10 ** -decimals, duration: 1000, easing: 'easeOutCubic',
                    update: () => el.innerHTML = `${obj.value.toFixed(decimals)}<span class="text-3xl">${suffix}</span>`
                });
            },
            aggregateBy(data, key) {
                const groups = data.reduce((acc, d) => {
                    const id = d[key]; if (!id) return acc;
                    if (!acc[id]) acc[id] = { scores: [] }; acc[id].scores.push(d.score); return acc;
                }, {});
                return Object.entries(groups).map(([k, stats]) => ({ key: k, count: stats.scores.length, avgScore: stats.scores.reduce((a,b)=>a+b,0) / stats.scores.length }));
            },
            aggregateByDate(data, dateKey, limitDays) {
                let filteredData = data;
                if(limitDays) {
                    const limit = new Date(); limit.setDate(limit.getDate() - limitDays);
                    filteredData = data.filter(d => d[dateKey] >= limit);
                }
                const agg = filteredData.reduce((a, d) => {
                    if (d[dateKey] instanceof Date && !isNaN(d[dateKey])) {
                        const k = d[dateKey].toISOString().split('T')[0]; a[k] = (a[k] || 0) + 1;
                    } return a;
                }, {});
                const labels = Object.keys(agg).sort((a,b) => new Date(a) - new Date(b));
                return { labels, data: labels.map(l => agg[l]) };
            },
            aggregateScoresByDate(data, dateKey, limitDays) {
                let filteredData = data;
                if(limitDays) {
                    const limit = new Date(); limit.setDate(limit.getDate() - limitDays);
                    filteredData = data.filter(d => d[dateKey] >= limit);
                }
                const agg = filteredData.reduce((a, d) => {
                    if (d[dateKey] instanceof Date && !isNaN(d[dateKey])) {
                        const k = d[dateKey].toISOString().split('T')[0];
                        if (!a[k]) a[k] = []; a[k].push(d.score);
                    } return a;
                }, {});
                const labels = Object.keys(agg).sort((a,b) => new Date(a) - new Date(b));
                return { labels, data: labels.map(l => agg[l].reduce((x,y) => x + y, 0) / agg[l].length) };
            },
            calculateStdDev(array) {
                const n = array.length; if (n === 0) return 0;
                const mean = array.reduce((a,b) => a+b) / n;
                return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a,b) => a+b) / n);
            },
            formatDate(date) {
                return (!(date instanceof Date) || isNaN(date)) ? 'N/A' : date.toLocaleString('en-GB', {day:'2-digit',month:'short',year:'numeric'});
            },
        }
    };

    App.init();

});
</script>
</body>
</html>
